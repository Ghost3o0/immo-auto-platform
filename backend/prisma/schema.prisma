// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  RENTED
  INACTIVE
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum PropertyType {
  APARTMENT
  HOUSE
  LAND
  COMMERCIAL
  OTHER
}

enum ListingType {
  SALE
  RENT
}

enum VehicleType {
  CAR
  MOTORCYCLE
  TRUCK
  VAN
  OTHER
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  LPG
  OTHER
}

enum Transmission {
  MANUAL
  AUTOMATIC
}

// Models
model User {
  id              String     @id @default(uuid())
  email           String     @unique
  password        String
  name            String
  phone           String?
  avatar          String?
  role            UserRole   @default(USER)
  status          UserStatus @default(ACTIVE)
  suspendedAt     DateTime?
  suspendedReason String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  properties Property[]
  vehicles   Vehicle[]
  favorites  Favorite[]

  // Messagerie
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  messages            Message[]

  // Préférences
  notificationPreferences NotificationPreference?

  // Admin relations
  adminLogs AdminLog[] @relation("AdminUser")
  reports   Report[]   @relation("Reporter")

  @@index([status])
  @@map("users")
}

model Property {
  id          String        @id @default(uuid())
  title       String
  description String
  price       Float
  address     String
  city        String
  zipCode     String
  country     String        @default("France")
  latitude    Float?
  longitude   Float?
  surface     Float
  rooms       Int
  bedrooms    Int
  bathrooms   Int
  type        PropertyType
  listingType ListingType
  status      ListingStatus @default(ACTIVE)
  features    String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  images        Image[]
  favorites     Favorite[]
  conversations Conversation[]
  views         PropertyView[]
  reports       Report[]

  @@index([city])
  @@index([price])
  @@index([type])
  @@index([listingType])
  @@index([status])
  @@map("properties")
}

model Vehicle {
  id           String        @id @default(uuid())
  title        String
  description  String
  price        Float
  brand        String
  model        String
  year         Int
  mileage      Int
  fuelType     FuelType
  transmission Transmission
  color        String
  doors        Int
  seats        Int
  power        Int?
  type         VehicleType
  listingType  ListingType
  status       ListingStatus @default(ACTIVE)
  features     String[]      @default([])
  city         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  images        Image[]
  favorites     Favorite[]
  conversations Conversation[]
  views         VehicleView[]
  reports       Report[]

  @@index([brand])
  @@index([price])
  @@index([year])
  @@index([type])
  @@index([listingType])
  @@index([status])
  @@map("vehicles")
}

model Image {
  id        String   @id @default(uuid())
  data      String
  mimeType  String
  filename  String?
  createdAt DateTime @default(now())

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("images")
}

model Favorite {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@unique([userId, vehicleId])
  @@map("favorites")
}

model Conversation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Participants
  buyerId String
  buyer   User   @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)

  // Annonce concernée (optionnel car peut être supprimée)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  messages Message[]

  @@unique([buyerId, sellerId, propertyId])
  @@unique([buyerId, sellerId, vehicleId])
  @@index([buyerId])
  @@index([sellerId])
  @@map("conversations")
}

model Message {
  id        String   @id @default(uuid())
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model PropertyView {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  viewedAt   DateTime @default(now())

  @@index([propertyId])
  @@index([viewedAt])
  @@map("property_views")
}

model VehicleView {
  id        String   @id @default(uuid())
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@index([vehicleId])
  @@index([viewedAt])
  @@map("vehicle_views")
}

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification types
  emailOnNewMessage    Boolean @default(true)
  emailOnNewFavorite   Boolean @default(true)
  emailOnListingViews  Boolean @default(true)
  emailOnListingExpiry Boolean @default(true)
  pushNotifications    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// Admin models
model Report {
  id           String       @id @default(uuid())
  reason       String
  status       ReportStatus @default(PENDING)
  createdAt    DateTime     @default(now())
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?

  // Reporter
  reporterId String
  reporter   User   @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  // Target (one of these must be set)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([reporterId])
  @@index([propertyId])
  @@index([vehicleId])
  @@map("reports")
}

model AdminLog {
  id         String   @id @default(uuid())
  action     String
  targetType String
  targetId   String
  details    String?
  createdAt  DateTime @default(now())

  // Admin who performed the action
  adminId String
  admin   User   @relation("AdminUser", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_logs")
}
